<!DOCTYPE html>
<html>
<head>
<style type="text/css">
body{
	background-position: center;
    background-color: #90C98F;
	margin: 0 0px;
	padding: 0px 0px;
	font-family: 'supria_sans';
}
@font-face {
    font-family: 'bauhausc_demi';
    src: url('https://zapsters.github.io/Home/fonts/bauhausc_demibold_regular-webfont.woff2') format('woff2'),
    url('https://zapsters.github.io/Home/fonts/bauhausc_demibold_regular-webfont.woff') format('woff');
    font-weight: normal;
    font-style: normal;
}

@font-face {
    font-family: supria_sans;
    src: url('https://zapsters.github.io/Home/fonts/SupriaSans-Bold.woff') format('woff');
	font-weight: normal;
    font-style: normal;
}
p {
	font-family: 'supria_sans';
}
.sub {
	font-family: 'supria_sans';
	color: #000;
	text-decoration: none;
	font-size: 30px;
	letter-spacing: 0px;
	margin: 0 0px;
	padding: 0px 0px;
}
.header {
    position: relative;
	background-color:rgba(73, 121, 53, 1);
	width:100%;
	text-align: center;
	padding: 20px 0;
}
.writableContent {
	position: relative;
	width: 60%;
	left: 50%;
	margin-left: -30%;
	padding: 0px 0px;
}
.player {
	width: 30px;
	height: 30px;
	background-color: cyan;
	-webkit-transition: all .2s ease;
  -moz-transition: all .2s ease;
  transition: all .2s ease;
	color: white;
	text-align: center;
	display: inline-block;
}
.player_nametag {
	background-color: rgba(0, 66, 99, 0);
	transform: translate(-0px, -23px);
	width: 280px;
	margin-left: -140px;
	position: absolute;
	text-align: center;
	display: inline-block;
}
.border {
	outline-color: black;
	background-color: rgba(0, 66, 99, .5);
	height: 500px;
	width: 500px;
	display: inline-block;
}
.bottom_div {
	font-family: 'supria_sans';
	position:absolute;
	bottom:0;
	width:100%;
	height:70px;
	font-size: 15px;
	text-align: left;
}
</style>
	<title>MultiplayerTest</title>
	<link rel="shortcut icon" type="image/png" href="https://zapsters.github.io/Home/images/ZapsterGames.png"/>

</head>

<body>
<div class="header">
	<p class="sub">Multiplayer Test</p>
</div>
<div class="border">
	<div class="player" id="host_player">
		<div class="player_nametag" style="transform: translate(-0px, -40px); color: #fff; ">
			<p id="host_player_nametext">???</p>
		</div>
	</div>
</div>

<div class="bottom_div" id="logged_in_as" style="display: block">
	<p id="version_bottom_text" class="sub" style="font-size: 20px;"><br><br></p>
</div>

<script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-functions.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.22.1/firebase-database.js"></script>

<script>
// Your web app's Firebase configuration
var firebaseConfig = {
	apiKey: "AIzaSyBGpegMBm6fR6RkbstowC_zAtAX38e5HkI",
	authDomain: "testing-5a258.firebaseapp.com",
	databaseURL: "https://testing-5a258.firebaseio.com",
	projectId: "testing-5a258",
	storageBucket: "testing-5a258.appspot.com",
	messagingSenderId: "435727985183",
	appId: "1:435727985183:web:217a91511be9c7ad1fc32a"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
//const	db = firebase.firestore();
var database = firebase.database();

</script>

<script>
var host_player_position = [250, 250];
var host_player_identity_x = host_player_position[0];
var host_player_identity_y = host_player_position[1];
var movementspeed = 10;
let keysPressed = {};
var roomcode = 'multiplayer_test'
var version = '1.0.0'
document.getElementById('version_bottom_text').innerHTML = '<br><br>' + version;

function getUrlVars() {
	var vars = [], hash;
	var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
	for(var i = 0; i < hashes.length; i++) {
	 hash = hashes[i].split('=');
	 vars.push(hash[0]);
	 vars[hash[0]] = hash[1];
	}
	return vars;
}

//Name length limit of 20! Add the user to the database!
var name_raw = getUrlVars()["name"];
if(name_raw == undefined) {
	var name_raw = prompt("Please enter your name.", "");
	if(name_raw == null || name_raw == "") {
		alert('No username entered. Closing');
		myWindow.close();
	} else {
		var name_filtered = (name_raw.substring(0, 20));
		document.getElementById('host_player_nametext').innerHTML = name_filtered;
		firebase.database().ref(roomcode + '/users/' + name_raw).set({
	    username: name_raw,
			x: host_player_position[0],
			y: host_player_position[1]
  	});
	}
}
host_player_position_update()

//Start checking for updates in the databaseURL
var roomcode_users_ref = firebase.database().ref(roomcode + '/users');
roomcode_users_ref.on('child_added', function(doc) {
  roomcode_users_ref_data = doc.val();
	var newchild_username = roomcode_users_ref_data.username;
	var newchild_positionx = roomcode_users_ref_data.x;
	var newchild_positiony = roomcode_users_ref_data.y;
	deletePlayers();
	createPlayer(newchild_username, newchild_positiony, newchild_positionx)
	console.log(newchild_username)
});

//Child changed
var roomcode_users_ref = firebase.database().ref(roomcode + '/users');
roomcode_users_ref.on('child_changed', function(doc) {
  roomcode_users_ref_data = doc.val();
	new_child_username = roomcode_users_ref_data.username;
	new_child_y = roomcode_users_ref_data.y;
	new_child_x = roomcode_users_ref_data.x;
	//console.log('child changed');
	//createPlayer(new_child_username, new_child_x, new_child_y);
		//Try will check for errors as it runs
		try {
			if(new_child_username != name_filtered) {
				console.log(new_child_username, "position: " + new_child_x + " // " + new_child_y)
				current_new_child_id = 'host_' + new_child_username;
				var document_new_child = document.getElementById(current_new_child_id);
				document_new_child.style.position = "absolute";
				document_new_child.style.left = new_child_y + 'px';
				document_new_child.style.top = new_child_x + 'px';
			}
		}
		catch(err) {
			//If an error happens when updating player position, Check the database and create any and all players. Should fix the errors in most cases.
			console.log('Reloading Players // ' + err)
			deletePlayers(new_child_username);
			createPlayer(new_child_username, new_child_y, new_child_x)
			console.log(new_child_username)
		}
});

//Child deleted
var roomcode_users_ref = firebase.database().ref(roomcode + '/users');
roomcode_users_ref.on('child_removed', function(doc) {
	deletePlayers('all')
})

//Delete players
function deletePlayers(username) {
	console.log('delete')
	var allplayers = document.getElementsByClassName("player")
	var i;
	for (i = 0; i < allplayers.length; i++) {
		var current_player_id = allplayers[i].id
		console.log(current_player_id)
		if (current_player_id != 'host_player' && current_player_id == username) {
	  	allplayers[i].remove();
		}
		if (current_player_id != 'host_player' && username == 'all') {
	  	allplayers[i].remove();
		}
	}
}

//When the page is closed delete the user's file
window.onbeforeunload = function(){
	firebase.database().ref(roomcode + '/users/').set({
	});
}

//Creates a player element with a custom name.
function createPlayer(name, x, y) {
	if(name != name_raw) {
		deletePlayers(name)
		var allplayers = document.getElementsByClassName(name)
		var i;
		var newPlayer = document.createElement("div");
		newPlayer.setAttribute('class', 'player ' + name);
		newPlayer.setAttribute("id", "host_" + name);
		var newPlayerNametag = document.createElement("div");
		newPlayerNametag.setAttribute('class', 'player_nametag');
		var new_user_name_filtered = (name.substring(0, 20)); 	//Filter the new users name
		var newPlayerNameContent = document.createTextNode(new_user_name_filtered);
		newPlayer.appendChild(newPlayerNametag);
		newPlayerNametag.appendChild(newPlayerNameContent);

		const border_div = document.getElementById("border");
	  document.body.insertBefore(newPlayer, border_div);
		var newcreateplayer = document.getElementById("host_" + name);
		newcreateplayer.style.position = "absolute";
		newcreateplayer.style.left = x + 'px';
		newcreateplayer.style.top = y + 'px';
	}
}

function host_player_position_update() {
	//console.log(host_player_position);
	var host_player_identity = document.getElementById('host_player');
	host_player_identity_x = host_player_position[0];
	host_player_identity_y = host_player_position[1];
	host_player_identity.style.position = "absolute";
	host_player_identity.style.left = host_player_identity_y+'px';
	host_player_identity.style.top = host_player_identity_x+'px';

	document.getElementById('host_player_nametext').innerHTML = name_filtered;
	firebase.database().ref(roomcode + '/users/' + name_raw).set({
		username: name_raw,
		x: host_player_position[0],
		y: host_player_position[1]
	});
}

//Constantly runs. Checks if a button is being held.
check_movement_button()
function check_movement_button() {
	if (keysPressed['w']) {
		host_player_identity_x = host_player_identity_x + -movementspeed;
	}
	if (keysPressed['a']) {
		host_player_identity_y = host_player_identity_y + -movementspeed;
	}
	if (keysPressed['s']) {
		host_player_identity_x = host_player_identity_x + movementspeed;
	}
	if (keysPressed['d']) {
		host_player_identity_y = host_player_identity_y + movementspeed;
	}
	host_player_position = [host_player_identity_x, host_player_identity_y]
	host_player_position_update()
	//console.log(keysPressed)
	setTimeout(function(){
		check_movement_button()
	}, 50);
}

//If button is pressed, add it to keysPressed array.
document.addEventListener('keydown', (event) => {
   keysPressed[event.key] = true;
});

//If button is released, remove it from keysPressed array.
document.addEventListener('keyup', (event) => {
   delete keysPressed[event.key];
});


//Onblur remove pressed keys. Prevents character getting stuck in a certain direction.
window.onblur = function() {
   keysPressed = {};
	 console.log('unfocused!')
};
</script>
</body>
</html>
